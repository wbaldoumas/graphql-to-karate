name: Integration Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: ğŸ”¨ set up .net 7
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 7.0.x

    - name: ğŸ¥‹ generate karate feature
      run: dotnet run --project src/GraphQLToKarate.CommandLine/GraphQLToKarate.CommandLine.csproj convert resources/mini-blog.graphql --non-interactive --base-url \"http://localhost:9001\" --include-mutations --custom-scalar-mapping DateTime:string

    - name: ğŸ’¨ run integration api
      run: dotnet run --project tests/GraphQLToKarate.Integration.Api/GraphQLToKarate.Integration.Api.csproj --urls http://localhost:9001/ &

    - name: ğŸ¥± wait for integration api
      run: sleep 10s

    - name: ğŸ”¨ set up java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: ğŸ”§ download karate
      run: curl -L -o karate.jar https://github.com/karatelabs/karate/releases/download/v1.4.0/karate-1.4.0.jar

    - name: ğŸ¥‹ run karate
      run: java -jar karate.jar graphql.feature
